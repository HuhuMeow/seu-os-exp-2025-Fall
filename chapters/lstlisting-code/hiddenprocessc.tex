\begin{lstlisting}[caption = {\texttt{fs/proc/hidden\_process.c}}]
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/proc_fs.h>
#include <linux/seq_file.h>
#include <linux/sched.h>        /* 包含 task_struct 定义 */
#include <linux/sched/signal.h> /* 包含 for_each_process 宏 */
#include <linux/init.h>

/*
 * seq_file 的 show 函数
 * 当用户 cat /proc/hidden_process 时被调用
 */
static int hidden_proc_show(struct seq_file *m, void *v)
{
    struct task_struct *p;
    seq_printf(m, "PID\tCOMMAND\n");

    rcu_read_lock();
    for_each_process(p)
        if (p->hide_flag == 1) seq_printf(m, "%d\t%s\n", p->pid, p->comm);
    rcu_read_unlock();

    return 0;
}

static int hidden_proc_open(struct inode *inode, struct file *file)
{
    return single_open(file, hidden_proc_show, NULL);
}

static const struct proc_ops hidden_proc_ops = {
    .proc_open    = hidden_proc_open,
    .proc_read    = seq_read,
    .proc_lseek   = seq_lseek,
    .proc_release = single_release,
};

static int __init hidden_proc_init(void)
{
    struct proc_dir_entry *entry;
    
    entry = proc_create("hidden_process", 0444, NULL, &hidden_proc_ops);
    if (!entry) {
        pr_err("Failed to create /proc/hidden_process\n");
        return -ENOMEM;
    }
    
    return 0;
}

/* 使用 fs_initcall 保证在文件系统初始化时加载 */
fs_initcall(hidden_proc_init);
\end{lstlisting}
